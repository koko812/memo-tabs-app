# 🌐 ネットワークまわりの理解メモ（macOS中心）

---

## 📚 目次

1. 🔌 [ポート番号とは？](#ポート番号とは)
2. 🧠 [クライアントとサーバーでのポートの使い方](#クライアントとサーバーでのポートの使い方)
3. 🔍 [`lsof` の出力解読メモ](#lsof-の出力解読メモ)
4. 📝 [Notes.app の正体](#notesapp-の正体)
5. 🐳 [Dockerとポート](#dockerとポート)
6. 🔐 [Same-Origin Policy（SOP）とCORSの基礎](#same-origin-policysopとcorsの基礎)
7. 💬 [疑問と解消まとめ](#疑問と解消まとめ)
8. 📘 [関連コマンドメモ](#関連コマンドメモ)

---

## 🔌 ポート番号とは？

* **0〜65535** まで存在（16bitの符号なし整数）
* 用途に応じて以下のように分類：

| 範囲          | 名称        | 用途例                              |
| ----------- | --------- | -------------------------------- |
| 0〜1023      | ウェルノウンポート | HTTP (80), HTTPS (443), SSH (22) |
| 1024〜49151  | 登録済みポート   | PostgreSQL (5432), MySQL (3306)  |
| 49152〜65535 | エフェメラルポート | 一時接続（クライアント側）に使われる               |

---

## 🧠 クライアントとサーバーでのポートの使い方

* \*\*クライアント（ユーザーPC）**は、アクセスごとに**エフェメラルポート（49152〜65535）\*\*と呼ばれる動的なポート番号を使って接続します。
* **サーバー側**は、通常は決まった番号のポート（例えば `443` や `80`）を開けて、そこに外部からのリクエストを待ち受けています。

### 🔄 通信の流れの具体例（HTTPSアクセス）

あなたが Google Chrome を開いて `https://example.com` にアクセスしたとします。

```
あなたのPC:56234 → example.com:443
```

このとき：

* **56234** はクライアント側（あなたのPC）のエフェメラルポート番号（OSが自動で割り当て）
* **443** はサーバー側（example.com）のHTTPSポート番号（固定）

### 🧪 他の具体例

* Spotify:

  * `あなたのPC:49321 → spotify.com:443`
* Zoom:

  * `あなたのPC:51012 → zoom.us:8801`
* Google検索:

  * `あなたのPC:54033 → www.google.com:443`

これらはすべて「あなた側の一時ポート」→「相手側の固定ポート」という構図。

### 👀 裏で何が起きている？

* クライアントは毎回異なる一時ポート番号を使うことで、複数の接続を並列で行うことができる。
* OSは「どのポート番号から出ていった通信か」を記録しておき、戻ってきたレスポンスを正しく元のアプリに返す。
* サーバー側は常に固定の「入り口ポート」を開けて待ち受けている。

### 💡 開発者の場合は…

* サーバーを立てるということは「自分のPCで特定のポートを開けてリクエストを待つ」こと。
* 例：Reactの開発サーバー（ポート3000）、Flaskアプリ（ポート5000）など

---

## 🔍 `lsof` の出力解読メモ

### 出力例：

```
COMMAND     PID USER   FD   TYPE DEVICE SIZE/OFF NODE NAME
chrome     12345 user  34u  IPv4  ...     0t0     TCP 192.168.0.2:49155->142.250.196.78:443 (ESTABLISHED)
```

| カラム        | 意味                                           |
| ---------- | -------------------------------------------- |
| `COMMAND`  | 実行中のプロセス名（chromeなど）                          |
| `PID`      | プロセスID（プロセスごとの識別番号）                          |
| `USER`     | 実行ユーザー名                                      |
| `FD`       | ファイルディスクリプタ（例: `34u` = 34番で読み書き可能）           |
| `TYPE`     | 通信タイプ：IPv4 / IPv6 / unixなど                   |
| `DEVICE`   | OS内部デバイス識別子（通常気にしなくてよい）                      |
| `SIZE/OFF` | 通信であれば `0t0`（あまり意味なし）                        |
| `NODE`     | 通信種別：TCP, UDP など                             |
| `NAME`     | 最も重要。接続先アドレスとポート・状態など（ESTABLISHED, LISTENなど） |

### よく見るFDの種類（FD列）

| 記号       | 意味                                    |
| -------- | ------------------------------------- |
| `cwd`    | カレントディレクトリ（Current Working Directory） |
| `txt`    | 実行中のバイナリ本体                            |
| `mem`    | メモリマッピングされたファイル                       |
| 数字 + `u` | 通信中のファイル記述子（例: `34u`）                 |
| `r`, `w` | 読み込み専用、書き込み専用を示す記号                    |

FD列はプロセスが開いているファイルやソケットの「窓口番号」とモードの組み合わせ。

### `lsof` 活用例

```bash
# Chrome の全ての通信を見る
lsof -c Chrome

# 特定ポート（8080）を使っているプロセスを探す
lsof -i :8080

# 通信状態が ESTABLISHED のものを絞り込む
lsof -i -nP | grep ESTABLISHED
```

---


## 📝 Notes.app の正体

* macOS に標準搭載されている Apple 純正の「メモ」アプリ。
* `lsof` でプロセス名として `Notes` と表示される。
* アプリを起動していなくても、iCloud との同期や Spotlight によるインデックス化のため、裏で通信やファイルアクセスが発生する。
* 通信先として `icloud.com:443` などが表示されることがある。

---

## 🐳 Dockerとポート

* Docker は macOS 上では仮想マシン内で Linux 環境として動作する（HyperKit や QEMU）
* コンテナ内でサーバーを動かしても、デフォルトでは macOS のホストからは見えない（仮想環境のため）

### 🔁 `-p 8080:80` の意味

* `8080`（ホスト側のポート）を `80`（コンテナ側のポート）に転送する設定
* これにより、`localhost:8080` にアクセスすれば、Docker コンテナ内の `:80` に届くようになる

### 🌉 例：nginx サーバー

```bash
docker run -p 8080:80 nginx
```

* 外部からは `http://localhost:8080`
* コンテナ内では `nginx` が `:80` を LISTEN

### 📌 見え方の違い

| 視点    | アクセス先                          |
| ----- | ------------------------------ |
| Mac 側 | `localhost:8080`               |
| コンテナ内 | `0.0.0.0:80` or `localhost:80` |

---

## 🔐 Same-Origin Policy（SOP）とCORSの基礎

* **オリジン（Origin）** = スキーム（http/https） + ホスト名 + ポート番号
* これらのどれか1つでも異なれば、別オリジンと判定される
* ブラウザは、異なるオリジンからのアクセスをブロック（SOP: Same-Origin Policy）

### ❗ 実例

* `http://localhost:3000` と `http://localhost:5173` はポートが異なるため**別オリジン**
* `http://127.0.0.1:3000` と `http://localhost:3000` も**ホスト名が違うので別オリジン**

### 💡 CORSとは？

* Cross-Origin Resource Sharing（クロスオリジンリソース共有）
* サーバー側が特別に `Access-Control-Allow-Origin` を返すことで、他オリジンからのアクセスを許可する仕組み

---

## 💬 疑問と解消まとめ

| 疑問                      | 気づき・答え                                      |
| ----------------------- | ------------------------------------------- |
| 自分のPCって本当に複数ポート使ってるの？   | ✅ Zoom, Spotify, Chrome など全て一時ポートで通信中       |
| lsof の FD って何？          | ✅ ファイル記述子。何番の“窓口”でどんなアクセスモードか（u=read/write） |
| Dockerのポートってどう外とつながってる？ | ✅ `-p` オプションでホストからコンテナ内のポートにフォワーディング        |
| Notesってなんで出てくるの？        | ✅ mac標準のメモアプリがiCloudと同期中だったりする              |

---

## 📘 関連コマンドメモ

```bash
# 現在のTCP通信を一覧表示
lsof -i -nP | grep ESTABLISHED

# 特定のポートを使っているプロセスを見る
lsof -i :8080

# Docker コンテナ内のプロセスを見る
docker exec -it <container_id> lsof -i

# 現在使われている一時ポート範囲を確認（Linux）
cat /proc/sys/net/ipv4/ip_local_port_range
```

---

（随時追加予定）
