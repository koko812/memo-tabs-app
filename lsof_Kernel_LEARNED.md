# 🧬 カーネルとファイルディスクリプタの仕組みメモ

## 📚 目次

1. [UNIX哲学：すべてはファイル](#unix哲学すべてはファイル)
2. [ファイルディスクリプタ（FD）とは？](#ファイルディスクリプタfdとは)
3. [プロセスとカーネルの関係](#プロセスとカーネルの関係)
4. [開かれたファイルがどこで管理されているか](#開かれたファイルがどこで管理されているか)
5. [lsofが読み取っている情報の場所](#lsofが読み取っている情報の場所)
6. [補足：/proc の構造（Linux）](#補足proc-の構造linux)

---

## 🧠 UNIX哲学：すべてはファイル

UNIX系OS（macOS, Linuxなど）では「すべてはファイル」とみなされます。

* テキストファイル → 通常のファイル
* デバイス → `/dev/sda`, `/dev/tty` など
* ネットワークソケット → ファイル記述子として扱う
* パイプやプロセス間通信（IPC） → 一時ファイルのように管理

つまり、**プロセスが何かを「開く」＝ファイルディスクリプタを得る**ことを意味します。

---

## 🔢 ファイルディスクリプタ（FD）とは？

* FD（File Descriptor）は、\*\*プロセスが保持する「開かれたファイルの番号」\*\*です。
* 整数で管理され、最初の3つは標準で予約：

| FD番号 | 対応するもの             |
| ---- | ------------------ |
| 0    | 標準入力 (`stdin`)     |
| 1    | 標準出力 (`stdout`)    |
| 2    | 標準エラー出力 (`stderr`) |

* それ以外のFD（3, 4, 5…）は、ソケットやファイル、パイプなどに割り当てられます。

---

## 🧵 プロセスとカーネルの関係

* プロセス（ユーザー空間）は直接ハードウェアにアクセスできません
* 代わりに、カーネルに「このファイル開いて」「このソケットつないで」と頼みます（`open()`, `read()`, `write()`, `connect()` など）
* カーネルは実際の管理を行い、プロセスにFDを渡します
* FDは「プロセスにとってのハンドル」であり、内部的には**カーネル内のテーブルを参照**します

---

## 📑 開かれたファイルがどこで管理されているか

カーネルの中では、FDは次のような構造で管理されています：

1. **プロセステーブル**

   * 各プロセスごとにFDの配列（最大1024など）を持つ
2. **ファイルディスクリプタテーブル**（プロセスごと）

   * 各FDが指すのは「ファイル構造体（struct file）」
3. **ファイル構造体** → **inode**

   * 実際のファイルの情報、パーミッション、位置情報

つまり：

```
[ユーザー空間] → fd: 3
     ↓
[プロセスのFDテーブル] → struct file → inode → 実ファイル or ソケット
```

---

## 🔍 lsofが読み取っている情報の場所

* `lsof` は、カーネルが管理しているFD情報を読み取って表示しています
* macOSでは `/dev/kmem`（カーネルメモリ）などを使う
* Linuxでは `/proc/<pid>/fd/` や `/proc/<pid>/maps` から取得
* だから `lsof` は\*\*FDが何を指しているか（ファイルか、ソケットか、どこに繋がっているか）\*\*を一覧で表示できる

---

## 🗂 補足：`/proc` の構造（Linux）

Linuxの場合：

* `/proc` はプロセスごとの疑似ファイルシステム
* たとえば：

```
/proc/1234/     ← PID 1234 の情報
/proc/1234/fd/  ← 開いてるFDの一覧（シンボリックリンク）
/proc/1234/maps ← メモリマップ情報
/proc/net/tcp  ← TCP接続一覧
```

* `ls -l /proc/1234/fd` すると、開かれてるファイルやソケットがわかる！


### 🔡 lsofの略称

* `lsof` = **List Open Files**
* プロセスが開いているファイル／ソケット／デバイスなどを一覧表示するコマンド

### 🔧 関連コマンド一覧

| コマンド           | 内容                     | 備考                    |
| -------------- | ---------------------- | --------------------- |
| `lsof`         | 開かれているファイル／ソケットの一覧を表示  | macOS / Linux 共通      |
| `fstat`        | BSD系（macOSなど）での類似コマンド  | `lsof` より軽量なことも       |
| `netstat`      | ネットワークソケットの状態表示（古め）    | 非推奨気味、macOSではまだ使える    |
| `ss`           | `netstat` の後継（Linux限定） | より高速で詳細な出力            |
| `ps`           | 実行中プロセスの一覧             | `ps aux`, `ps -ef` など |
| `top` / `htop` | プロセスとリソース使用状況のリアルタイム表示 | `htop` はインタラクティブ UI   |

これらを組み合わせて使うことで、**カーネル・プロセス・通信の状態を横断的に理解できるようになります。**

---

随時追加予定
